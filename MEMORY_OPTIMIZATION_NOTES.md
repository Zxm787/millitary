# ุชุญุณููุงุช ุญู ูุดููุฉ ุชุฌุงูุฒ ุญุฏ ุงูุฐุงูุฑุฉ ูู MongoDB

## ุงููุดููุฉ ุงูุฃุตููุฉ
```
errmsg: "PlanExecutor error during aggregation :: caused by :: Exceeded memory limit for $group, but didn't allow external spilling; pass allowDiskUse:true to opt in"
```

ุชุญุฏุซ ูุฐู ุงููุดููุฉ ุนูุฏูุง ุชุญุงูู ุนูููุฉ ุงูุชุฌููุน (`$group`) ูู MongoDB ุงุณุชุฎุฏุงู ุฐุงูุฑุฉ ุฃูุซุฑ ูู ุงูุญุฏ ุงููุณููุญ (100MB ุงูุชุฑุงุถูุงู).

## ุงูุญููู ุงููุทุจูุฉ

### 1. ุฅุถุงูุฉ `allowDiskUse: true`
ุชู ุฅุถุงูุฉ ูุฐุง ุงูุฎูุงุฑ ูุฌููุน ุนูููุงุช ุงูุชุฌููุน ููุณูุงุญ ุจุงููุชุงุจุฉ ุนูู ุงููุฑุต ุงูุตูุจ ุนูุฏ ุชุฌุงูุฒ ุญุฏ ุงูุฐุงูุฑุฉ:

**ุงููููุงุช ุงูููุญุฏุซุฉ:**
- `index.js`: ุฏุงูุฉ `migrateInventorySystem()` ู `calculateTotalEconomy()`
- `database-manager.js`: ุฏุงูุฉ `removeDuplicateUsers()`

```javascript
// ูุจู ุงูุชุญุณูู
const result = await UserItem.aggregate([...]);

// ุจุนุฏ ุงูุชุญุณูู
const result = await UserItem.aggregate([...], { allowDiskUse: true });
```

### 2. ุงุณุชุฎุฏุงู Cursor ุจุฏูุงู ูู ุชุญููู ุฌููุน ุงููุชุงุฆุฌ
ุชู ุงุณุชุจุฏุงู ุชุญููู ุฌููุน ุงููุชุงุฆุฌ ูู ุงูุฐุงูุฑุฉ ุจุงุณุชุฎุฏุงู cursor ูููุนุงูุฌุฉ ูุงุญุฏุงู ุชูู ุงูุขุฎุฑ:

```javascript
// ูุจู ุงูุชุญุณูู
const duplicateItems = await UserItem.aggregate([...]);
for (const duplicate of duplicateItems) { ... }

// ุจุนุฏ ุงูุชุญุณูู
const cursor = UserItem.aggregate([...], { allowDiskUse: true }).cursor();
for (let duplicate = await cursor.next(); duplicate != null; duplicate = await cursor.next()) { ... }
```

### 3. ุชุญุณูู ุนูููุงุช ุงูุชุญุฏูุซ
ุชู ุงุณุชุจุฏุงู ุงูุญููุงุช ุงููุชุนุฏุฏุฉ ุจุนูููุงุช `updateMany` ุฃูุซุฑ ููุงุกุฉ:

```javascript
// ูุจู ุงูุชุญุณูู
const items = await UserItem.find({ quantity: { $exists: false } });
for (const item of items) {
    item.quantity = 1;
    await item.save();
}

// ุจุนุฏ ุงูุชุญุณูู
await UserItem.updateMany(
    { $or: [{ quantity: { $exists: false } }, { quantity: null }, { quantity: 0 }] },
    { $set: { quantity: 1 } }
);
```

### 4. ุฅุถุงูุฉ ูุนุงูุฌุฉ ุฃุฎุทุงุก ูุญุณูุฉ
ุชู ุฅุถุงูุฉ ูุนุงูุฌุฉ ุฃุฎุทุงุก ุฃูุถู ูุน ุทุฑู ุจุฏููุฉ ูู ุญุงูุฉ ูุดู ุงูุชุฌููุน:

```javascript
try {
    // ุนูููุฉ ุงูุชุฌููุน ุงูุฃุณุงุณูุฉ
    const result = await User.aggregate([...], { allowDiskUse: true, maxTimeMS: 30000 });
} catch (error) {
    // ุทุฑููุฉ ุจุฏููุฉ ุจุงุณุชุฎุฏุงู ุนููุฉ ูู ุงูุจูุงูุงุช
    const totalUsers = await User.countDocuments();
    const sampleUsers = await User.find({}, 'coins').limit(1000);
    // ุญุณุงุจ ุชูุฏูุฑู ููุงูุชุตุงุฏ
}
```

### 5. ุฅุถุงูุฉ ุชุณุฌูู ุงูุชูุฏู
ุชู ุฅุถุงูุฉ ุชุณุฌูู ููุชูุฏู ููุฑุงูุจุฉ ุงูุนูููุฉ:

```javascript
// ุชุณุฌูู ุงูุชูุฏู ูู 100 ุนูุตุฑ
if (migratedCount % 100 === 0) {
    console.log(`๐ Processed ${migratedCount} duplicate groups...`);
}
```

### 6. ุฅุถุงูุฉ ุชุฃุฎูุฑ ุจูู ุงูุนูููุงุช
ูุชูููู ุงูุถุบุท ุนูู ูุงุนุฏุฉ ุงูุจูุงูุงุช:

```javascript
// ุชุฃุฎูุฑ ูุตูุฑ ูู 50 ุนูุตุฑ
if (migratedCount % 50 === 0) {
    await new Promise(resolve => setTimeout(resolve, 100));
}
```

## ุงููููุงุช ุงูููุญุฏุซุฉ

### `index.js`
- **ุฏุงูุฉ `migrateInventorySystem()`**: ุชุญุณูู ุดุงูู ุจุงุณุชุฎุฏุงู cursor ู allowDiskUse
- **ุฏุงูุฉ `calculateTotalEconomy()`**: ุฅุถุงูุฉ allowDiskUse ูุทุฑููุฉ ุจุฏููุฉ

### `database-manager.js`
- **ุฏุงูุฉ `removeDuplicateUsers()`**: ุชุญุณูู ุจุงุณุชุฎุฏุงู cursor ู allowDiskUse

### ูููุงุช ุฌุฏูุฏุฉ
- **`test-migration.js`**: ููู ุงุฎุชุจุงุฑ ููุชุฃูุฏ ูู ุนูู ุงูุชุญุณููุงุช
- **`MEMORY_OPTIMIZATION_NOTES.md`**: ูุฐุง ุงูููู ููุชูุซูู

## ููููุฉ ุงูุงุฎุชุจุงุฑ

```bash
# ุงุฎุชุจุงุฑ ุงูุชุญุณููุงุช
node test-migration.js
```

## ุงูููุงุฆุฏ ุงููุญููุฉ

1. **ุชุฌูุจ ุฎุทุฃ ุชุฌุงูุฒ ุญุฏ ุงูุฐุงูุฑุฉ**: `allowDiskUse: true` ูุณูุญ ุจุงููุชุงุจุฉ ุนูู ุงููุฑุต
2. **ุงุณุชุฎุฏุงู ุฐุงูุฑุฉ ุฃูู**: cursor ูุนุงูุฌ ุงูุจูุงูุงุช ูุงุญุฏุงู ุชูู ุงูุขุฎุฑ
3. **ุฃุฏุงุก ุฃูุถู**: ุนูููุงุช `updateMany` ุฃุณุฑุน ูู ุงูุญููุงุช ุงููุชุนุฏุฏุฉ
4. **ููุซูููุฉ ุฃุนูู**: ูุนุงูุฌุฉ ุฃุฎุทุงุก ูุญุณูุฉ ูุน ุทุฑู ุจุฏููุฉ
5. **ูุฑุงูุจุฉ ุฃูุถู**: ุชุณุฌูู ุงูุชูุฏู ูุญุงูุฉ ุงูุนูููุฉ

## ููุงุญุธุงุช ูููุฉ

- ุชุฃูุฏ ูู ูุฌูุฏ ูุณุงุญุฉ ูุงููุฉ ุนูู ุงููุฑุต ุงูุตูุจ ุนูุฏ ุงุณุชุฎุฏุงู `allowDiskUse: true`
- ุงูุนูููุงุช ูุฏ ุชุณุชุบุฑู ููุชุงู ุฃุทูู ูุน `allowDiskUse` ููููุง ุณุชูุฌุญ ูุน ุงูุจูุงูุงุช ุงููุจูุฑุฉ
- ูููุตุญ ุจุชุดุบูู ุฃูุฑ `!ุชุญููู_ุงููุฎุฒูู` ูู ุฃููุงุช ุงูุฐุฑูุฉ ุงูููุฎูุถุฉ
- ุฑุงูุจ ุงุณุชุฎุฏุงู ุงููุณุงุญุฉ ูุงูุฐุงูุฑุฉ ุฃุซูุงุก ุชุดุบูู ุงูุนูููุฉ

## ุงูุงุณุชุฎุฏุงู

ุจุนุฏ ุชุทุจูู ูุฐู ุงูุชุญุณููุงุชุ ูููู ุงุณุชุฎุฏุงู ุฃูุฑ `!ุชุญููู_ุงููุฎุฒูู` ุจุฃูุงู ุญุชู ูุน ููุงุนุฏ ุงูุจูุงูุงุช ุงููุจูุฑุฉ (512MB ูุฃูุซุฑ).