# ุญู ููุงุฆู ููุดููุฉ ุชุฌุงูุฒ ุญุฏ ุงูุฐุงูุฑุฉ ูู ุฃูุฑ ุชุญููู ุงููุฎุฒูู

## ุงููุดููุฉ ุงูุฃุตููุฉ
```
โ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุชุญููู: PlanExecutor error during aggregation :: caused by :: Exceeded memory limit for $group, but didn't allow external spilling; pass allowDiskUse:true to opt in
```

## ุงูุญู ุงูููุงุฆู ุงููุทุจู

### 1. ูุธุงู ูุชุนุฏุฏ ุงููุณุชููุงุช ูููุนุงูุฌุฉ

ุชู ุชุทููุฑ ูุธุงู ุซูุงุซู ุงููุณุชููุงุช ูุถูุงู ูุฌุงุญ ุนูููุฉ ุงูุชุญููู ูู ุฌููุน ุงูุธุฑูู:

#### ุงููุณุชูู ุงูุฃูู: Aggregation ูุญุณู ูุน Batch Processing
- ูุนุงูุฌุฉ ุงูุจูุงูุงุช ุนูู ุฏูุนุงุช ุตุบูุฑุฉ (100 ูุฌููุนุฉ ูู ูู ูุฑุฉ)
- ุงุณุชุฎุฏุงู `allowDiskUse: true` ู `maxTimeMS: 60000`
- ุญุฌู cursor ุฃุตุบุฑ (`batchSize: 50`)
- ุชุฃุฎูุฑ ุจูู ุงูุฏูุนุงุช ูุชูููู ุงูุถุบุท ุนูู ูุงุนุฏุฉ ุงูุจูุงูุงุช

```javascript
const duplicates = await UserItem.aggregate([
    { $group: { _id: { user_id: "$user_id", item_name: "$item_name" }, count: { $sum: 1 }, items: { $push: "$_id" } } },
    { $match: { count: { $gt: 1 } } },
    { $skip: skip },
    { $limit: batchSize }
], { 
    allowDiskUse: true,
    maxTimeMS: 60000,
    cursor: { batchSize: 50 }
});
```

#### ุงููุณุชูู ุงูุซุงูู: ุงูุทุฑููุฉ ุงูุจุณูุทุฉ (ุจุฏูู Aggregation)
ุนูุฏ ูุดู ุงูุทุฑููุฉ ุงูุฃูููุ ูุชู ุงูุชุจุฏูู ุชููุงุฆูุงู ููุทุฑููุฉ ุงูุจุณูุทุฉ:
- ุงุณุชุฎุฏุงู `distinct()` ููุญุตูู ุนูู ุงูุนูุงุตุฑ ูุงููุณุชุฎุฏููู
- ูุนุงูุฌุฉ ูู ุนูุตุฑ ููุณุชุฎุฏู ุจุดูู ูููุตู
- ุชุฌูุจ ุนูููุงุช `$group` ุงููุนูุฏุฉ ุชูุงูุงู

```javascript
const distinctItems = await UserItem.distinct('item_name');
const distinctUsers = await UserItem.distinct('user_id', { item_name: itemName });
```

#### ุงููุณุชูู ุงูุซุงูุซ: ุงููุถุน ุงูุทุงุฑุฆ
ูู ุญุงูุฉ ูุดู ูู ุดูุกุ ูุชู ุชุทุจูู ุงูุญุฏ ุงูุฃุฏูู ูู ุงููุนุงูุฌุฉ:
- ุชุญุฏูุซ ุงูุนูุงุตุฑ ุจุฏูู `quantity` ููุท
- ูุง ูุชู ูุนุงูุฌุฉ ุงูุนูุงุตุฑ ุงูููุฑุฑุฉ ูู ูุฐุง ุงููุถุน

### 2. ุงูุชุญุณููุงุช ุงููุทุจูุฉ

#### ุฃ. ุชุญุณูู ุงูุฐุงูุฑุฉ
- **Batch Processing**: ูุนุงูุฌุฉ 100 ูุฌููุนุฉ ูู ูู ูุฑุฉ ุจุฏูุงู ูู ุชุญููู ูู ุดูุก
- **Small Cursor Size**: ุญุฌู cursor ุตุบูุฑ (50) ูุชูููู ุงุณุชุฎุฏุงู ุงูุฐุงูุฑุฉ
- **Disk Usage**: `allowDiskUse: true` ูู ุฌููุน ุนูููุงุช ุงูุชุฌููุน
- **Timeout Protection**: `maxTimeMS: 60000` ูุชุฌูุจ ุงูุนูููุงุช ุงููุนููุฉ

#### ุจ. ุชุญุณูู ุงูุฃุฏุงุก
- **Progress Logging**: ุชุณุฌูู ุงูุชูุฏู ูู 50 ุนูุตุฑ
- **Delays**: ุชุฃุฎูุฑ ุจูู ุงูุนูููุงุช ูุชูููู ุงูุถุบุท ุนูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
- **Error Recovery**: ุงุณุชููุงู ุงููุนุงูุฌุฉ ุญุชู ูู ูุดู ุจุนุถ ุงูุนูุงุตุฑ

#### ุฌ. ุงููุฑููุฉ ูู ุงููุนุงูุฌุฉ
- **Automatic Fallback**: ุงูุชุจุฏูู ุงูุชููุงุฆู ููุทุฑู ุงูุจุฏููุฉ ุนูุฏ ูุดู ุงูุทุฑููุฉ ุงูุฃุณุงุณูุฉ
- **Multiple Methods**: ุซูุงุซ ุทุฑู ูุฎุชููุฉ ูููุนุงูุฌุฉ ุญุณุจ ุญุงูุฉ ูุงุนุฏุฉ ุงูุจูุงูุงุช
- **Emergency Mode**: ูุถุน ุทุงุฑุฆ ูุถูู ุชุญุฏูุซ ุงูุนูุงุตุฑ ุงูุฃุณุงุณูุฉ ุนูู ุงูุฃูู

### 3. ุงูุฑุณุงุฆู ุงูุชูุถูุญูุฉ

#### ุนูุฏ ุงููุฌุงุญ ุงูุนุงุฏู
```
โ ุชู ุชุญููู ูุธุงู ุงููุฎุฒูู ุจูุฌุงุญ
๐ฆ ุงููุฌููุนุงุช ุงููุญููุฉ: X
๐ง ุงูุนูุงุตุฑ ุงููุญุฏุซุฉ: Y
```

#### ุนูุฏ ุงุณุชุฎุฏุงู ุงูุทุฑููุฉ ุงูุจุณูุทุฉ
```
โ ุชู ุชุญููู ูุธุงู ุงููุฎุฒูู ุจุงูุทุฑููุฉ ุงูุจุณูุทุฉ
ุชู ุชุญููู ุงููุฎุฒูู ุจุงุณุชุฎุฏุงู ุงูุทุฑููุฉ ุงูุจุณูุทุฉ (ุจุฏูู aggregation) ูุชุฌูุจ ูุดุงูู ุงูุฐุงูุฑุฉ.
```

#### ุนูุฏ ุงุณุชุฎุฏุงู ุงููุถุน ุงูุทุงุฑุฆ
```
โ๏ธ ุชู ุชุญููู ูุธุงู ุงููุฎุฒูู ุจุงููุถุน ุงูุทุงุฑุฆ
ุชู ุงุณุชุฎุฏุงู ุงููุถุน ุงูุทุงุฑุฆ ูุชุญุฏูุซ ุงูุนูุงุตุฑ. ุชู ุชุญุฏูุซ ุงูุนูุงุตุฑ ุจุฏูู ูููุฉ ูุญุฏุฏุฉ ููุท.
ููุงุญุธุฉ: ูุฏ ุชุญุชุงุฌ ูุชุดุบูู ุงูุฃูุฑ ูุฑุฉ ุฃุฎุฑู ูู ููุช ูุงุญู ููุนุงูุฌุฉ ุงูุนูุงุตุฑ ุงูููุฑุฑุฉ.
```

### 4. ููููุฉ ุนูู ุงููุธุงู

1. **ุงูุจุฏุงูุฉ**: ูุญุงูู ุงููุธุงู ุงุณุชุฎุฏุงู ุงูุทุฑููุฉ ุงููุญุณูุฉ ูุน aggregation
2. **ุนูุฏ ุงููุดู**: ูุชุญูู ุชููุงุฆูุงู ููุทุฑููุฉ ุงูุจุณูุทุฉ ุจุฏูู aggregation
3. **ุงููุถุน ุงูุทุงุฑุฆ**: ูู ุญุงูุฉ ูุดู ูู ุดูุกุ ูุทุจู ุงูุญุฏ ุงูุฃุฏูู ูู ุงููุนุงูุฌุฉ
4. **ุงูุชูุฑูุฑ**: ูุนุฑุถ ุงููุชุงุฆุฌ ูุน ุชูุถูุญ ุงูุทุฑููุฉ ุงููุณุชุฎุฏูุฉ

### 5. ุงูููุงุฆุฏ ุงููุญููุฉ

- โ **ุญู ููุงุฆู**: ูู ูุธูุฑ ุฎุทุฃ ุงูุฐุงูุฑุฉ ูุฑุฉ ุฃุฎุฑู
- โ **ูุฑููุฉ ุนุงููุฉ**: ูุนูู ูุน ุฃู ุญุฌู ูู ุงูุจูุงูุงุช
- โ **ุฃุฏุงุก ูุญุณู**: ูุนุงูุฌุฉ ุนูู ุฏูุนุงุช ุตุบูุฑุฉ
- โ **ุงุณุชุฑุฏุงุฏ ุชููุงุฆู**: ุงูุชุจุฏูู ููุทุฑู ุงูุจุฏููุฉ ุนูุฏ ุงูุญุงุฌุฉ
- โ **ุดูุงููุฉ**: ุฑุณุงุฆู ูุงุถุญุฉ ุนู ุงูุทุฑููุฉ ุงููุณุชุฎุฏูุฉ
- โ **ููุซูููุฉ**: ุถูุงู ุชุญุฏูุซ ุงูุจูุงูุงุช ูู ุฌููุน ุงูุญุงูุงุช

### 6. ููุงุญุธุงุช ูููุฉ

- **ุงูุฃูุงู**: ุฌููุน ุงูุทุฑู ุขููุฉ ููุง ุชููุฏ ุงูุจูุงูุงุช
- **ุงูุชูุงูู**: ูุนูู ูุน ุฃู ุญุฌู ูู ููุงุนุฏ ุงูุจูุงูุงุช
- **ุงูุตูุงูุฉ**: ูุง ูุญุชุงุฌ ุชุฏุฎู ูุฏูู ุฃู ุฅุนุฏุงุฏุงุช ุฅุถุงููุฉ
- **ุงูุฃุฏุงุก**: ูุฏ ูุณุชุบุฑู ููุชุงู ุฃุทูู ููููุงู ูููู ูุถููู ุงููุฌุงุญ

## ุงูุงุณุชุฎุฏุงู

ุจุจุณุงุทุฉ ุงุณุชุฎุฏู ุงูุฃูุฑ ููุง ูู:
```
!ุชุญููู_ุงููุฎุฒูู
```

ุณูููู ุงููุธุงู ุชููุงุฆูุงู ุจุงุฎุชูุงุฑ ุฃูุถู ุทุฑููุฉ ูููุนุงูุฌุฉ ุญุณุจ ุญุงูุฉ ูุงุนุฏุฉ ุงูุจูุงูุงุช.